
import React, { useState, useCallback } from 'react';
import { CyberInput } from '../CyberInput';
import { ExplanationDisplay } from '../ExplanationDisplay';
import { LoadingSpinner } from '../LoadingSpinner';
import { getVulnerabilityAnalysis } from '../../services/geminiService';
import { SearchIcon } from '../icons/SearchIcon';

export const VulnerabilityScanner: React.FC = () => {
    const [query, setQuery] = useState<string>('');
    const [analysis, setAnalysis] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string | null>(null);

    const handleAnalyze = useCallback(async (prompt: string) => {
        if (!prompt || isLoading) return;

        setIsLoading(true);
        setError(null);
        setAnalysis('');

        try {
            const result = await getVulnerabilityAnalysis(prompt);
            setAnalysis(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Ocorreu um erro inesperado. Por favor, tente novamente.');
        } finally {
            setIsLoading(false);
        }
    }, [isLoading]);

    return (
        <>
            <CyberInput
                query={query}
                setQuery={setQuery}
                onAnalyze={() => handleAnalyze(query)}
                isLoading={isLoading}
                placeholder="ex: Uma aplicação web de e-commerce usando um backend NodeJS, um frontend React e um banco de dados MongoDB. Possui um sistema de login de usuário e processa pagamentos via uma API de terceiros..."
                label="Descreva o sistema, rede ou aplicação a ser analisada"
                buttonText="Analisar"
                rows={6}
            />

            <div className="mt-6 flex-grow">
                {isLoading ? (
                    <div className="flex flex-col items-center justify-center h-full text-center">
                        <LoadingSpinner />
                        <p className="mt-4 text-indigo-400 animate-pulse">Analisando vetores de ameaça...</p>
                    </div>
                ) : error ? (
                    <div className="bg-red-900/50 border border-red-500 text-red-300 p-4 rounded-lg">
                        <h3 className="font-bold">Erro</h3>
                        <p>{error}</p>
                    </div>
                ) : analysis ? (
                    <ExplanationDisplay content={analysis} />
                ) : (
                    <div className="text-center text-slate-500 flex flex-col items-center justify-center h-full">
                        <SearchIcon className="w-24 h-24 mb-4 text-slate-700" />
                        <h2 className="text-2xl text-slate-400 mb-2">Analisador de Vulnerabilidades</h2>
                        <p className="max-w-xl">
                            Forneça uma descrição detalhada da arquitetura de um sistema, aplicação ou configuração de rede. A IA identificará falhas de segurança potenciais e sugerirá mitigações.
                        </p>
                    </div>
                )}
            </div>
        </>
    );
};
